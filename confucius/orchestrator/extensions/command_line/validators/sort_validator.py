# Copyright (c) Meta Platforms, Inc. and affiliates.

# pyre-strict
from textwrap import dedent

from .....core.analect.analect import AnalectRunContext
from ..exceptions import InvalidCommandLineInput
from ..runner import CommandLineInput
from .cli_command_validator import CliCommandValidator


DISALLOWED_OPTIONS = [
    "-o",
    "--output",
]

OPTIONS_WITH_ARGS = [
    "--random-source",
    "--sort",
    "--batch-size",
    "--check",
    "--compress-program",
    "--files0-from",
    "-k",
    "--key",
    "-o",
    "--output",
    "-S",
    "--buffer-size",
    "-t",
    "--field-separator",
    "-T",
    "--temporary-directory",
    "--parallel",
]


class SortValidator(CliCommandValidator):
    async def run_validator(
        self,
        command_tokens: list[str],
        inp: CommandLineInput,
        context: AnalectRunContext,
    ) -> CommandLineInput:
        args = self.parse_posix_args(command_tokens, OPTIONS_WITH_ARGS)
        for arg in args.options:
            if arg[0] in DISALLOWED_OPTIONS:
                raise InvalidCommandLineInput(
                    dedent(
                        f"""\
                        <warning>
                        You are not allowed to use the `{arg[0]}` option with `sort`.
                        This is considered a security risk as it can bypass
                        safeguards in place to protect sensitive data.
                        </warning>\
                        """
                    )
                )
        return inp
